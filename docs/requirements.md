# 电流分析UI应用需求文档

## 项目概述
开发一个GUI应用程序，用于分析TDMS和NPZ文件中的电流数据，并提供交互式数据分析功能。

## 功能需求

### 1. 文件加载功能
- 支持加载TDMS文件格式
- 支持加载NPZ文件格式
- 文件选择器界面，允许用户浏览和选择文件

### 2. 数据处理
- **TDMS文件处理**：
  - 读取文件中含有"samplerate"字段的采样频率信息
  - 将数据点转换为正确的时间序列（基于采样频率）
- **NPZ文件处理**：
  - 读取numpy压缩文件中的"current"和"time"字段

### 3. 数据可视化
- **交互式图表**：
  - 横坐标：时间 (s)
  - 纵坐标：电流 (A)
  - 支持鼠标操作（缩放、平移、选择等）
  - 实时显示鼠标位置的坐标值

### 4. 数据分析功能
- **阈值分析**：
  - 用户输入threshold值的输入框
  - "Analyze"按钮触发分析
  - 筛选出小于threshold的电流数据段
  
- **峰值检测**：
  - 在筛选出的数据段中，检测下降幅度超过指定prominence的峰
  - prominence值由用户通过输入框指定
  - 记录峰值对应的时间点
  
- **峰值起点检测**：
  - 从峰值向前寻找电流开始下降的起点
  - 计算峰值振幅和相对参数

### 5. 结果导出
- **CSV文件导出**：
  - 包含完整的峰值分析数据
  - 支持选择性导出（用户可选择特定峰值）
  - 自动保存或手动保存选项

### 6. 多文件数据可视化
- **CSV文件导入**：
  - 支持批量导入多个CSV文件
  - 自动去重和增量导入
  
- **数据可视化**：
  - 箱线图（Box Plot）
  - 直方图（Histogram）
  - 散点图（Scatter Plot）
  
- **交互式分析**：
  - 动态列选择
  - 跨文件数据对比

## 用户界面设计要求
- 简洁直观的操作界面
- 标签化界面（单事件分析 + 多文件可视化）
- 文件加载区域
- 参数设置区域（threshold输入、prominence输入、height输入）
- 背景颜色选择
- 大面积的图表显示区域
- 结果显示和导出区域
- 峰值审核功能（复选框列表）

## 技术要求
- Python + PyQt5框架
- 支持TDMS文件格式读取（npTDMS库）
- 支持NPZ文件格式读取
- 交互式图表库（pyqtgraph）
- CSV文件操作
- 跨平台兼容性
- 科学计算库（scipy, numpy, pandas）

## 用户交互流程

### 单事件分析流程
1. 用户选择并加载TDMS或NPZ文件夹
2. 系统自动绘制时间-电流曲线图
3. 用户设置threshold参数、prominence值和height值
4. 点击"Analyze"按钮进行分析
5. 系统识别峰值并显示结果
6. 用户在峰值审核界面选择要导出的峰值
7. 导出结果到CSV文件

### 多文件可视化流程
1. 用户导入多个CSV文件
2. 选择文件查看可用列
3. 添加感兴趣的列到分析列表
4. 选择图表类型（Box Plot/Histogram/Scatter Plot）
5. 生成可视化图表
6. 根据需要清除或更新图表

## 数据输出格式
CSV文件包含以下字段：
- file_name: 文件名
- peak_number: 峰值编号
- total_time: 总时间（低于阈值）
- peak_t: 峰值时间
- peak_i: 峰值电流
- peak_start_i: 峰值起点电流
- peak_start_t: 峰值起点时间
- peak_amplitude: 峰值振幅（prominence值）
- peak_rel_t: 相对时间比例
- peak_rel_i: 相对电流比例

## 性能要求
- 支持大型TDMS文件（数十MB）
- 流畅的图表交互（缩放、平移）
- 快速的峰值检测算法
- 响应式用户界面

## 扩展性要求
- 模块化设计，便于添加新的分析功能
- 可配置的分析参数
- 支持不同的文件格式扩展
- 插件化架构设计

## 错误处理要求
- 文件加载错误提示
- 数据格式验证
- 参数范围检查
- 用户友好的错误信息
- 程序异常恢复机制

